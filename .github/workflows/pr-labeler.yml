name: PR Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    name: Apply File Labels
    runs-on: ubuntu-latest
    steps:
      - uses: actions/labeler@v6
        with:
          configuration-path: .github/labeler.yml
          sync-labels: true

  release-none:
    name: Auto release:none for docs/CI PRs
    runs-on: ubuntu-latest
    needs: label
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect docs/CI-only PR
        id: detect
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          FILES=$(git diff --name-only "$BASE_SHA"..HEAD)

          HAS_SRC=0
          HAS_DOCS=0
          HAS_CI=0

          while IFS= read -r file; do
            case "$file" in
              src/infoextract_cidoc/tests/*) ;;          # tests don't count as src
              src/*) HAS_SRC=1 ;;
              docs/*.md|docs/**|*.md|mkdocs.yml) HAS_DOCS=1 ;;
              .github/*) HAS_CI=1 ;;
            esac
          done <<< "$FILES"

          RELEASE_NONE=0
          if [ "$HAS_SRC" = "0" ] && { [ "$HAS_DOCS" = "1" ] || [ "$HAS_CI" = "1" ]; }; then
            RELEASE_NONE=1
          fi

          echo "release_none=$RELEASE_NONE" >> $GITHUB_OUTPUT

      - name: Ensure release:none label exists
        if: steps.detect.outputs.release_none == '1'
        run: |
          gh label create "release:none" \
            --color "e4e669" \
            --description "Docs/CI-only â€” no release entry needed" \
            --force
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply release:none label
        if: steps.detect.outputs.release_none == '1'
        run: gh pr edit ${{ github.event.pull_request.number }} --add-label "release:none"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post label summary (on open only)
        if: github.event.action == 'opened'
        run: |
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} \
            --json labels --jq '[.labels[].name] | join(", ")')
          if [ -n "$LABELS" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "Labels applied: \`$LABELS\`"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
